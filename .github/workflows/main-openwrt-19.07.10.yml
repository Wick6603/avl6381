# workflow name
name: Build avl6381 Driver (openwrt-19.07.10-ralink-mt7620)

# trigger the workflow manually from the GitHub UI
on:
  workflow_dispatch:

# Define a single job named 'build'
jobs:
  build:
    # use a Linux runner
    runs-on: ubuntu-latest
    
    # steps to be executed in the job
    steps:
      # step 1: check out the repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # step 2: download and extract the ImmortalWrt SDK
      - name: Download and Extract SDK
        run: |
          wget https://downloads.openwrt.org/releases/19.07.10/targets/ramips/mt7620/openwrt-sdk-19.07.10-ramips-mt7620_gcc-7.5.0_musl.Linux-x86_64.tar.xz
          tar xvf openwrt-sdk-19.07.10-ramips-mt7620_gcc-7.5.0_musl.Linux-x86_64.tar.xz

      # step 3: compile the driver
      # all compilation steps are combined into one run block
      - name: Compile Driver
        # set environment variables and run make commands
        run: |
          # The SDK is extracted, so we can define its path
          SDK_DIR=$(pwd)/openwrt-sdk-19.07.10-ramips-mt7620_gcc-7.5.0_musl.Linux-x86_64

          # Set the environment variables as per the instructions
          export ARCH=mips
          export STAGING_DIR="${SDK_DIR}/staging_dir/toolchain-mipsel_24kc_gcc-7.5.0_musl/bin/"
          export KERNEL_DIR="${SDK_DIR}/build_dir/target-mipsel_24kc_musl/linux-ralink_mt7620/linux-4.14.275"
          export TOOLCHAIN="${SDK_DIR}/staging_dir/toolchain-mipsel_24kc_gcc-7.5.0_musl/bin/mipsel-openwrt-linux-"
          
          # Check if the directories exist before compiling
          ls -l $STAGING_DIR
          ls -l $KERNEL_DIR
          
          # Run the compilation steps
          make prepare
          make

      # step 4: create a directory for the compiled modules and copy the files
      - name: Stage compiled modules
        run: |
          mkdir -p build/ko_modules
          cp /home/runner/work/avl6381/avl6381/*.{ko,o} build/ko_modules/
          ls -l build/ko_modules/

      # step 5: upload the directory as a workflow artifact
      - name: Upload Driver as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-19.07.10-ralink-mt7620-avl6381-driver-modules
          path: build/ko_modules
